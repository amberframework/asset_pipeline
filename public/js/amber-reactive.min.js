/* Amber Reactive Client - Minified */
/* This is a placeholder - in production, use a proper minifier like Terser */
!function(e){"use strict";const t=1e3,n=3e4,o=3e4;class s{constructor(e={}){this.options={url:e.url||this._buildWebSocketUrl(),debug:e.debug||!1,reconnect:!1!==e.reconnect,heartbeat:!1!==e.heartbeat,morphdom:e.morphdom||window.morphdom,...e},this.components=new Map,this.socket=null,this.connected=!1,this.reconnectDelay=t,this.reconnectTimer=null,this.heartbeatTimer=null,this.messageQueue=[],this.sessionId=this._generateSessionId(),this._bindMethods(),this._setupMutationObserver()}init(){this._connect(),this._scanForComponents(),this._setupEventDelegation(),this.options.debug&&console.log("AmberReactive initialized",{sessionId:this.sessionId,url:this.options.url})}_connect(){if(this.socket&&this.socket.readyState===WebSocket.OPEN)return;try{this.socket=new WebSocket(this.options.url),this._setupSocketHandlers()}catch(e){this._log("error","Failed to connect:",e),this._scheduleReconnect()}}_setupSocketHandlers(){this.socket.onopen=()=>{this.connected=!0,this.reconnectDelay=t,this._log("info","Connected to server"),this._send({type:"register",sessionId:this.sessionId,components:Array.from(this.components.keys())}),this._flushMessageQueue(),this.options.heartbeat&&this._startHeartbeat()},this.socket.onclose=()=>{this.connected=!1,this._stopHeartbeat(),this._log("info","Disconnected from server"),this.options.reconnect&&this._scheduleReconnect()},this.socket.onerror=e=>{this._log("error","WebSocket error:",e)},this.socket.onmessage=e=>{try{const t=JSON.parse(e.data);this._handleMessage(t)}catch(e){this._log("error","Failed to parse message:",e)}}}_handleMessage(e){switch(this._log("debug","Received message:",e),e.type){case"update":this._updateComponent(e.componentId,e.html,e.state);break;case"batch_update":e.updates.forEach(e=>{this._updateComponent(e.componentId,e.html,e.state)});break;case"reload":window.location.reload();break;case"eval":if(e.code)try{eval(e.code)}catch(e){this._log("error","Failed to evaluate code:",e)}break;case"pong":break;default:this._log("warn","Unknown message type:",e.type)}}_updateComponent(e,t,n){const o=document.querySelector(`[data-component-id="${e}"]`);o?(this.options.morphdom?this.options.morphdom(o,t,{onBeforeElUpdated:(e,t)=>(e===document.activeElement&&"INPUT"===e.tagName&&requestAnimationFrame(()=>{const t=e.selectionStart;e.focus(),e.setSelectionRange(t,t)}),!0)}):o.outerHTML=t,n&&this.components.has(e)&&(this.components.get(e).state=n),this._scanForComponents(o.parentElement)):this._log("warn","Component not found:",e)}_scanForComponents(e=document){e.querySelectorAll("[data-component-id]").forEach(e=>{const t=e.dataset.componentId;if(!this.components.has(t)){const n={id:t,element:e,type:e.dataset.componentType||"unknown",state:{}};this.components.set(t,n),this.connected&&this._send({type:"component_added",componentId:t,componentType:n.type})}})}_setupEventDelegation(){document.addEventListener("click",this._handleAction),document.addEventListener("submit",this._handleAction),document.addEventListener("input",this._handleAction),document.addEventListener("change",this._handleAction)}_handleAction(e){const t=e.target,n=t.dataset.action;if(!n)return;const[o,s]=n.split("->");if(o!==e.type)return;const i=t.closest("[data-component-id]");if(!i)return;const c=i.dataset.componentId;"submit"===e.type&&e.preventDefault();const a=this._gatherEventData(e,t);this._send({type:"action",componentId:c,method:s,event:a})}_gatherEventData(e,t){const n={type:e.type,timestamp:Date.now()};switch(e.type){case"input":case"change":n.value=t.value,n.name=t.name;break;case"submit":const o=e.target,s=new FormData(o);n.fields={};for(const[e,t]of s.entries())n.fields[e]=t;break;case"click":n.x=e.clientX,n.y=e.clientY}return n}_setupMutationObserver(){if(!window.MutationObserver)return;const e=new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&this._scanForComponents(e)})})});this._mutationObserver=e}_startObserving(){this._mutationObserver&&this._mutationObserver.observe(document.body,{childList:!0,subtree:!0})}_send(e){this.connected&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify(e)):this.messageQueue.push(e)}_flushMessageQueue(){for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();this._send(e)}}_startHeartbeat(){this._stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.connected&&this._send({type:"ping"})},o)}_stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}_scheduleReconnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>{this._log("info","Attempting to reconnect..."),this._connect()},this.reconnectDelay),this.reconnectDelay=Math.min(2*this.reconnectDelay,n)}_bindMethods(){this._handleAction=this._handleAction.bind(this)}_buildWebSocketUrl(){const e="https:"===window.location.protocol?"wss:":"ws:";return`${e}//${window.location.host}/reactive`}_generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}_log(e,...t){(this.options.debug||"error"===e)&&console[e]("[AmberReactive]",...t)}updateComponent(e,t){this._send({type:"update_state",componentId:e,state:t})}on(e,t){document.addEventListener(`amber:${e}`,t)}emit(e,t){const n=new CustomEvent(`amber:${e}`,{detail:t});document.dispatchEvent(n)}disconnect(){this.options.reconnect=!1,this.socket&&this.socket.close()}reconnect(){this.options.reconnect=!0,this._connect()}}e.AmberReactive=s,document.addEventListener("DOMContentLoaded",()=>{if(document.body.dataset.amberReactive){const t=new s;t.init(),e.amberReactive=t}})}(window);